/* 
   You can convert this graph to a PNG image with this command:

   dot -v -Tpng pageview_zero.dot  -o pageview_zero.png
   see https://en.wikipedia.org/wiki/DOT_(graph_description_language) for syntax
*/

digraph G {
     Legend [shape=none, margin="0,0", width=1, label=<
     <TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="4">
      <TR>
       <TD><B>Legend</B></TD>
      </TR>
      <TR>
       <TD bgcolor="CornflowerBlue">Start state</TD>
      </TR>
      <TR>
       <TD bgcolor="red">Rejected state</TD>
      </TR>
      <TR>
       <TD bgcolor="green">Accepted state</TD>
      </TR>
      <TR>
       <TD bgcolor="gold">Decision state</TD>
      </TR>
     </TABLE>
    >]
 
   webrequest_log_line         [label="Receive request from the mobile pageview decision tree\n (https://github.com/wikimedia/metrics/blob/master/pageviews/kraken/pageview_definition.png)",style=filled,color="CornflowerBlue"];
   decision_is_zero_traffic    [label="Request comes from a Wikipedia Zero carrier ip4/ip6 cidr range\n (https://meta.wikimedia.org/w/index.php?title=Special%3APrefixIndex&prefix=&namespace=480)", style=filled, color="Gold"];
   decision_is_opera           [label="Wikipedia Zero config is OPERA", style=filled, color="Gold"];
   //decision_is_test          [label="Wikipedia Zero config is TEST", style=filled, color="Gold"];
   process_xff                 [label="Replace ip4/ip6 addresss with left-most address from XFF field", style=filled, color="Gold"];

   discard                     [label="Log line should not count towards the Zero pageview metric", style=filled, color="Red"];
   count                       [label="Log line should be counted towards the Zero pageview metric", style=filled, color="Green"];

  webrequest_log_line          -> decision_is_zero_traffic;

  decision_is_zero_traffic     -> decision_is_opera            [ label="yes" ]; 
  decision_is_zero_traffic     -> discard                      [ label="no" ];

  decision_is_opera            -> process_xff                  [ label="yes" ];
  decision_is_opera            -> count                        [ label="no" ];

  process_xff                  -> count                        [ label="yes" ];
  
};
